{
    "manifestVersion": "1.0.0",
    "name": "LinuxLogMonitor",
    "displayName": "Linux 日志监控器",
    "version": "1.3.0",
    "description": "事件驱动的 Linux 日志监控系统。v1.3.0 新增：可配置去重策略、主动查询命令(searchLog/lastErrors/logStats)、异常上下文增强(before/after)。与 LinuxShellExecutor 共享 SSHManager 模块。",
    "author": "VCP Team",
    "pluginType": "asynchronous",
    "entryPoint": {
        "type": "nodejs",
        "command": "node LinuxLogMonitor.js"
    },
    "communication": {
        "protocol": "stdio",
        "timeout": 3600000,
        "encoding": "utf-8"
    },
    "capabilities": {
        "invocationCommands": [
            {
                "commandIdentifier": "start",
                "description": "启动日志监控任务。这是一个异步操作，会立即返回 taskId，后台持续监控日志并在检测到异常时通过回调通知 Agent。\n\n参数:\n- hostId (字符串, 必需): 目标主机 ID，需在 LinuxShellExecutor 的 hosts.json 中配置。\n- logPath (字符串, 必需): 要监控的日志文件路径，如 /var/log/syslog。\n- rules (数组, 可选): 自定义检测规则，默认使用预置规则。\n- contextLines (数字, 可选, 默认10): before 上下文行数。\n- afterContextLines (数字, 可选, 默认等于contextLines): after 上下文行数。\n- dedupeMode (字符串, 可选, 默认'time-window'): 去重模式，可选 'permanent'(永久)、'time-window'(时间窗口)、'disabled'(禁用)。\n- dedupeWindow (数字, 可选, 默认60): 时间窗口秒数（仅 time-window 模式有效）。\n\n调用格式:\n<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」start「末」,\nhostId:「始」prod-server「末」,\nlogPath:「始」/var/log/syslog「末」\n<<<[END_TOOL_REQUEST]>>>",
                "example": "<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」start「末」,\nhostId:「始」prod-server「末」,\nlogPath:「始」/var/log/nginx/error.log「末」,\ncontextLines:「始」20「末」,\ndedupeMode:「始」time-window「末」,\ndedupeWindow:「始」30「末」\n<<<[END_TOOL_REQUEST]>>>"
            },
            {
                "commandIdentifier": "stop",
                "description": "停止指定的监控任务。\n\n参数:\n- taskId (字符串, 必需): 启动监控时返回的任务 ID。\n\n调用格式:\n<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」stop「末」,\ntaskId:「始」monitor-task-abc123「末」\n<<<[END_TOOL_REQUEST]>>>",
                "example": "<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」stop「末」,\ntaskId:「始」monitor-task-abc123「末」\n<<<[END_TOOL_REQUEST]>>>"
            },
            {
                "commandIdentifier": "status",
                "description": "查询所有活跃的监控任务状态。\n\n调用格式:\n<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」status「末」\n<<<[END_TOOL_REQUEST]>>>",
                "example": "<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」status「末」\n<<<[END_TOOL_REQUEST]>>>"
            },
            {
                "commandIdentifier": "list_rules",
                "description": "列出所有可用的异常检测规则，包括预置规则和自定义规则。\n\n调用格式:\n<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」list_rules「末」\n<<<[END_TOOL_REQUEST]>>>",
                "example": "<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」list_rules「末」\n<<<[END_TOOL_REQUEST]>>>"
            },
            {
                "commandIdentifier": "add_rule",
                "description": "添加自定义异常检测规则。\n\n参数:\n- name (字符串, 必需): 规则名称，如 'high_cpu'。\n- type (字符串, 必需): 规则类型，可选 'regex'(正则匹配)、'keyword'(关键词匹配)、'threshold'(阈值检测)。\n- pattern (字符串, 必需): 匹配模式。regex类型使用正则表达式，keyword类型使用关键词，threshold类型使用带捕获组的正则。\n- severity (字符串, 可选, 默认'warning'): 严重级别，可选 'info'、'warning'、'critical'。\n- cooldown (数字, 可选, 默认60000): 冷却时间（毫秒），同一规则触发后的静默期。\n\n调用格式:\n<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」add_rule「末」,\nname:「始」error_keyword「末」,\ntype:「始」regex「末」,\npattern:「始」\\b(ERROR|FATAL)\\b「末」,\nseverity:「始」critical「末」,\ncooldown:「始」30000「末」\n<<<[END_TOOL_REQUEST]>>>",
                "example": "<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」add_rule「末」,\nname:「始」oom_killer「末」,\ntype:「始」keyword「末」,\npattern:「始」Out of memory「末」,\nseverity:「始」critical「末」\n<<<[END_TOOL_REQUEST]>>>"
            },
            {
                "commandIdentifier": "searchLog",
                "description": "主动搜索日志内容（v1.3.0）。使用 grep 在指定日志文件中搜索匹配的内容。\n\n参数:\n- hostId (字符串, 必需): 目标主机 ID。\n- logPath (字符串, 必需): 日志文件路径。\n- pattern (字符串, 必需): grep 正则表达式，如 'error|failed|timeout'。\n- lines (数字, 可选, 默认100): 最多返回行数。\n- since (字符串, 可选): 时间范围，如 '1h'(1小时)、'30m'(30分钟)、'1d'(1天)。\n- context (数字, 可选, 默认0): 上下文行数（grep -C 参数）。\n\n调用格式:\n<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」searchLog「末」,\nhostId:「始」prod-server「末」,\nlogPath:「始」/var/log/nginx/error.log「末」,\npattern:「始」error|timeout「末」,\nlines:「始」50「末」,\nsince:「始」1h「末」\n<<<[END_TOOL_REQUEST]>>>",
                "example": "<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」searchLog「末」,\nhostId:「始」DB1「末」,\nlogPath:「始」/var/log/mysql/error.log「末」,\npattern:「始」ERROR|Warning「末」,\nlines:「始」100「末」,\ncontext:「始」3「末」\n<<<[END_TOOL_REQUEST]>>>"
            },
            {
                "commandIdentifier": "lastErrors",
                "description": "获取最近的错误日志（v1.3.0）。快速查看指定日志文件中最近的错误记录。\n\n参数:\n- hostId (字符串, 必需): 目标主机 ID。\n- logPath (字符串, 必需): 日志文件路径。\n- count (数字, 可选, 默认20): 返回的错误条数。\n- levels (数组, 可选, 默认['ERROR','FATAL','CRIT']): 要匹配的错误级别。\n\n调用格式:\n<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」lastErrors「末」,\nhostId:「始」prod-server「末」,\nlogPath:「始」/var/log/syslog「末」,\ncount:「始」30「末」\n<<<[END_TOOL_REQUEST]>>>",
                "example": "<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」lastErrors「末」,\nhostId:「始」web-server「末」,\nlogPath:「始」/var/log/nginx/error.log「末」,\ncount:「始」50「末」,\nlevels:「始」[\"error\",\"crit\",\"alert\"]「末」\n<<<[END_TOOL_REQUEST]>>>"
            },
            {
                "commandIdentifier": "logStats",
                "description": "日志统计分析（v1.3.0）。对日志进行分组统计，如按状态码、IP、路径等分组。\n\n参数:\n- hostId (字符串, 必需): 目标主机 ID。\n- logPath (字符串, 必需): 日志文件路径。\n- since (字符串, 可选, 默认'1h'): 时间范围。\n- groupBy (字符串, 可选, 默认'level'): 分组字段，可选 'level'(日志级别)、'status_code'(HTTP状态码)、'ip'(IP地址)、'hour'(按小时)。\n- top (数字, 可选, 默认10): 返回前 N 条统计结果。\n\n调用格式:\n<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」logStats「末」,\nhostId:「始」prod-server「末」,\nlogPath:「始」/var/log/nginx/access.log「末」,\nsince:「始」1h「末」,\ngroupBy:「始」status_code「末」\n<<<[END_TOOL_REQUEST]>>>",
                "example": "<<<[TOOL_REQUEST]>>>\ntool_name:「始」LinuxLogMonitor「末」,\ncommand:「始」logStats「末」,\nhostId:「始」web-server「末」,\nlogPath:「始」/var/log/nginx/access.log「末」,\nsince:「始」24h「末」,\ngroupBy:「始」ip「末」,\ntop:「始」20「末」\n<<<[END_TOOL_REQUEST]>>>"
            }
        ]
    },
    "webSocketPush": {
        "enabled": true,
        "targetClientType": "VCPLog",
        "messageType": "log_monitor_anomaly"
    },
    "dependencies": {
        "shared": ["SSHManager"]
    },
    "tags": ["monitoring", "logging", "ssh", "async", "event-driven", "robustness", "log-analysis", "search"]
}
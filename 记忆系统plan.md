# NeoDeskPet 记忆系统开发计划（最新版）

日期：2026-01-01  
执行者：Codex

## 0) 目标与原则（小白版）

目标：让桌宠像人一样管理记忆：
- 该记的会留下（长期有用的事实/偏好/约束）
- 越常被提起越牢（强化）
- 很久不用的会慢慢沉底/归档（遗忘）
- 发现矛盾时不会把自己写乱（冲突/版本/回滚）
- 保持端侧最低延迟（本地优先）

原则：
- 单机优先：SQLite 做主存储，不强制外置服务
- 先可观测再升级：任何“没触发/不命中/失败原因”都要在 UI 看得见
- 分阶段交付：先 M1~M4 把“自我管理闭环”做扎实，再上 M5/M6 提升召回上限

## 1) 已完成什么（当前状态）

### M1（已完成）：可观测 + 开关 + 一键总结
- 聊天窗增加“记忆状态栏”：采集/召回/自动提炼开关 + 有效消息数/cursor/距离下次提炼 N/上次提炼结果（时间/写入条数/失败原因）。
- 自动提炼与右键“一键总结”共用同一套参数与写入目标（跟随记忆控制台设置）。
- 计数口径：将连续 assistant（TTS 分句）合并为 1 条“有效消息”来计数，避免频繁自动提炼。
- 会话层 meta 持久化：`autoExtractCursor/LastRunAt/LastWriteCount/LastError` 等写入 chatStore，重启不丢。
- 解除“最多 200 条上下文”的硬限制（上限提升到 2000，并在 UI 控制与失败提示上更明确）。
- 记忆控制台设置持久化修复：关闭再打开不再丢选择。

### M2（已完成）：记忆元数据 + 强化/遗忘 + 排序
- SQLite `memory` 表新增元数据字段：
  - `importance/strength/access_count/last_accessed_at/retention/status/memory_type/source/pinned/updated_at`
- 召回排序升级：从“只看关键词相关”变成“相关性 × retention × importance（含 pinned/status 因子）”，更接近“常用更靠前”。
- 强化机制：每次召回命中后自动更新 `hit/last/strength/retention`（越被提起越牢）。
- 遗忘维护：启动时 + 每 6 小时跑一次维护，把长期不用且 retention 过低的记忆标成 `archived`；再次命中会回到 `active`。
- 控制台可观测：记忆列表展示 `status/ret/imp/str/hit/last/type/src/pin`。
- 自动提炼写入标记 `source=auto_extract`，便于后续“按来源批量处理”。

### M3（已完成）：冲突处理 + 历史版本（让记忆不会写乱）
- 新增 `memory_version`/`memory_conflict` 两张表：所有内容更新可追溯、可回滚；相似候选进入冲突队列而不是自动覆盖。
- 写入策略：对 `manual_note` 做相似/冲突检测（重复不新增、冲突入队），避免“越写越乱”。
- 控制台入口：待处理冲突（采用新/保留两条/合并/忽略）+ 当前记忆编辑保存（生成版本）+ 版本列表与一键回滚。

### M4（已完成）：生命周期管理（筛选/排序/批量）
- 后端 `listMemory` 支持按 `status/pinned/source/memoryType` 筛选，按 `createdAt/updatedAt/retention/...` 排序；`deleteByFilter` 与筛选参数一致。
- 新增元数据批量 API：对已选或“当前筛选全部”执行 归档/恢复/置顶/取消置顶。
- 控制台 UI 增加筛选/排序控件与批量按钮；归档不再被维护任务自动“恢复”（只会在命中强化/置顶时变为 active）。

### M5（已完成）：向量 + Tag 网络（显著提升模糊问法召回）
- SQLite 新增表：`tag/memory_tag/memory_embedding`，用于 Tag 召回与向量相似召回的数据存储。
- 后台索引维护：每 5 秒小批量补齐 Tags；启用向量后再小批量补齐 embeddings（不阻塞聊天主流程）。
- 召回管线升级：时间范围 → FTS5 → Tag 网络 →（可选）向量相似，并统一进行混合排序与命中强化。
- 设置页新增“召回增强（M5）”：Tag 开关/扩展数；向量开关/embeddings 模型/相似度阈值/TopK/扫描上限；支持可选独立 embeddings API。

### 已修复的关键体验问题（很重要）
- 避免“自命中”：召回发生在写入本轮用户消息之前，避免“每条消息都命中自己”导致统计失真。
- 模糊问法改进：FTS 不命中时，不再用 `LIKE %整句%`，而是提取关键词（去掉“还记得/我说过/吗”等外壳词）做 `LIKE %关键词%`，提升中文模糊问法命中。

## 2) 还要做什么（下一步做什么）

推荐顺序：M6（可选）。

### M6（已完成第一版，可继续迭代）：实体/关系层（内置 SQLite，LLM 抽取）
目标：用“实体/关系”补齐换说法的召回：当用户不说关键词、只说“那天那件事/那个东西”时，也能更稳地找到证据。

第一版已落地：
- SQLite 新增 KG 表：`kg_entity/kg_entity_mention/kg_relation/kg_memory_index` + `kg_entity_fts`，用于实体/关系存储与检索。
- 后台抽取任务：启用 KG 后，主进程每 7 秒小批量调用 LLM 抽取实体/关系并写入 SQLite（不阻塞聊天）。
- 召回接入 KG：在召回管线中新增 `KG` 层，命中实体后反查证据 `memory_rowid` 参与混合排序。
- 单独 API：KG 抽取默认使用独立 API 配置（不影响聊天模型/额度）。
- 可观测：聊天窗口状态栏 `召回` 会显示 `KG`，悬停可看各层命中计数与耗时。

后续可迭代方向（按需）：
- 增强“事件层”：把时间/地点/参与者组织成 `event`，支持 1~2 跳联想（谁→事件→相关人/物）。
- 控制台入口：增加 KG 查看/编辑/回滚（和 memory_version 思路一致）。

## 3) 验证与评测（每个里程碑都要做）

### 自动验证（每次改动必做）
- `npm run lint`
- `npx tsc -p tsconfig.json --noEmit`

### 手动冒烟（建议 5 分钟）
- 看得见：聊天窗状态栏/控制台状态字段能对上。
- 召回会强化：命中后 `hit/last/str` 会变化。
- 模糊问法可用：如“还记得手抓羊肉吗”能命中“我要吃手抓羊肉”。

### 回归评测（建议在 M5 后补齐）
- 固定一批 query（20~100 条），比较：命中率、误召回率、响应延迟（p95）。

## 4) 下一步执行建议（现在该做什么）

如果你确认 M5 效果稳定：开始评估 M6（实体/事件/关系层）。  
如果你更在意低延迟与维护成本：可以先不做 M6，把 M5 的参数（Tag 扩展/向量阈值/TopK/扫描上限）调到满意再说。
